{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Reports & Analytics</h1>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<!-- Report Type Selector -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="list-group">
                            <a href="{{ url_for('reports', type='stock') }}" 
                               class="list-group-item list-group-item-action {% if report_type == 'stock' %}active{% endif %}">
                                <i class="fas fa-boxes"></i> Stock Report
                            </a>
                            <a href="{{ url_for('reports', type='expiry') }}" 
                               class="list-group-item list-group-item-action {% if report_type == 'expiry' %}active{% endif %}">
                                <i class="fas fa-clock"></i> Expiry Report
                            </a>
                            <a href="{{ url_for('reports', type='sales') }}" 
                               class="list-group-item list-group-item-action {% if report_type == 'sales' %}active{% endif %}">
                                <i class="fas fa-chart-line"></i> Sales Report
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        {% if report_type == 'stock' %}
                        <!-- Stock Report -->
                        <h4 class="mb-3">Stock Report</h4>
                        <div class="table-responsive">
                            <table class="table table-striped" id="stockTable">
                                <thead>
                                    <tr>
                                        <th>Drug Name</th>
                                        <th>Category</th>
                                        <th>Batch No</th>
                                        <th>Manufacturer</th>
                                        <th>Quantity</th>
                                        <th>Cost Price</th>
                                        <th>Selling Price</th>
                                        <th>Expiry Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for drug in data %}
                                    <tr>
                                        <td>{{ drug.name }}</td>
                                        <td>{{ drug.category }}</td>
                                        <td><code>{{ drug.batch_no }}</code></td>
                                        <td>{{ drug.manufacturer }}</td>
                                        <td>
                                            <span class="badge {% if drug.quantity < 10 %}bg-danger{% elif drug.quantity < 20 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ drug.quantity }}
                                            </span>
                                        </td>
                                        <td>${{ "%.2f"|format(drug.cost_price) }}</td>
                                        <td>${{ "%.2f"|format(drug.selling_price) }}</td>
                                        <td>{{ drug.expiry_date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            {% set days_until = (drug.expiry_date - today).days %}
                                            {% if days_until < 0 %}
                                            <span class="badge bg-dark">Expired</span>
                                            {% elif days_until <= 90 %}
                                            <span class="badge bg-danger">Expiring Soon</span>
                                            {% else %}
                                            <span class="badge bg-success">Valid</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% elif report_type == 'expiry' %}
                        <!-- Expiry Report -->
                        <h4 class="mb-3">Expiry Report</h4>
                        
                        <div class="alert alert-danger mb-4">
                            <h5><i class="fas fa-skull-crossbones"></i> Expired Drugs ({{ data.expired|length }})</h5>
                        </div>
                        {% if data.expired %}
                        <div class="table-responsive mb-5">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Drug Name</th>
                                        <th>Batch No</th>
                                        <th>Manufacturer</th>
                                        <th>Quantity</th>
                                        <th>Expiry Date</th>
                                        <th>Days Expired</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for drug in data.expired %}
                                    <tr class="table-danger">
                                        <td>{{ drug.name }}</td>
                                        <td><code>{{ drug.batch_no }}</code></td>
                                        <td>{{ drug.manufacturer }}</td>
                                        <td>{{ drug.quantity }}</td>
                                        <td>{{ drug.expiry_date.strftime('%Y-%m-%d') }}</td>
                                        <td class="text-danger fw-bold">
                                            {{ (today - drug.expiry_date).days }} days
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> No expired drugs found.
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-warning mb-4">
                            <h5><i class="fas fa-clock"></i> Expiring Soon (Within 90 days) ({{ data.expiring_soon|length }})</h5>
                        </div>
                        {% if data.expiring_soon %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Drug Name</th>
                                        <th>Batch No</th>
                                        <th>Manufacturer</th>
                                        <th>Quantity</th>
                                        <th>Expiry Date</th>
                                        <th>Days Until Expiry</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for drug in data.expiring_soon %}
                                    <tr class="table-warning">
                                        <td>{{ drug.name }}</td>
                                        <td><code>{{ drug.batch_no }}</code></td>
                                        <td>{{ drug.manufacturer }}</td>
                                        <td>{{ drug.quantity }}</td>
                                        <td>{{ drug.expiry_date.strftime('%Y-%m-%d') }}</td>
                                        <td class="text-warning fw-bold">
                                            {{ (drug.expiry_date - today).days }} days
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> No drugs expiring soon.
                        </div>
                        {% endif %}
                        
                        {% elif report_type == 'sales' %}
                        <!-- Sales Report -->
                        <h4 class="mb-3">Sales Report - {{ period|capitalize }}</h4>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select" id="salesPeriod" onchange="loadSalesReport()">
                                    <option value="daily" {% if period == 'daily' %}selected{% endif %}>Daily Report</option>
                                    <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Weekly Report</option>
                                    <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Monthly Report</option>
                                </select>
                            </div>
                        </div>
                        
                        {% if data.sales %}
                        <div class="table-responsive">
                            <table class="table table-striped" id="salesTable">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Drug Name</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                        <th>Staff</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sale in data.sales %}
                                    <tr>
                                        <td>{{ sale.sale_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ sale.drug.name }}</td>
                                        <td>{{ sale.quantity }}</td>
                                        <td>${{ "%.2f"|format(sale.unit_price) }}</td>
                                        <td>${{ "%.2f"|format(sale.total_price) }}</td>
                                        <td>{{ sale.staff_name }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Sales Summary</h6>
                                        <p><strong>Total Sales:</strong> ${{ "%.2f"|format(data.sales|sum(attribute='total_price')) }}</p>
                                        <p><strong>Total Items Sold:</strong> {{ data.sales|sum(attribute='quantity') }}</p>
                                        <p><strong>Number of Transactions:</strong> {{ data.sales|length }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No sales data available for the selected period.
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadSalesReport() {
    var period = $('#salesPeriod').val();
    window.location.href = "{{ url_for('reports') }}?type=sales&period=" + period;
}

// Auto-refresh reports every 60 seconds
setTimeout(function() {
    window.location.reload();
}, 60000);
</script>
{% endblock %}